# ä¾›åº”å•†é‚®ä»¶ç¿»è¯‘ç³»ç»Ÿ

ç‹¬ç«‹çš„æ¡Œé¢ç«¯(Electron)é‚®ä»¶ç¿»è¯‘ç®¡ç†ç³»ç»Ÿï¼Œå¸®åŠ©é‡‡è´­äººå‘˜å¤„ç†å¤šè¯­è¨€ä¾›åº”å•†é‚®ä»¶å¾€æ¥ã€‚

## ç™»å½•æ–¹å¼

**ä½¿ç”¨å…¬å¸é‚®ç®±ç›´æ¥ç™»å½•**ï¼ˆä»…é™ `@jingzhicheng.com.cn`ï¼‰
- è¾“å…¥å…¬å¸é‚®ç®±å’Œå¯†ç 
- ç³»ç»Ÿé€šè¿‡IMAPéªŒè¯åè‡ªåŠ¨æ‹‰å–é‚®ä»¶
- é‚®ç®±æœåŠ¡å™¨ï¼š21cn ä¼ä¸šé‚®ç®±

### 21cn ä¼ä¸šé‚®ç®±è®¾ç½®

é¦–æ¬¡ä½¿ç”¨å‰ï¼Œéœ€è¦åœ¨ 21cn ä¼ä¸šé‚®ç®±åå°å¼€å¯ SMTP æœåŠ¡ï¼š

1. ç™»å½• https://mail.21cn.net
2. è¿›è¡Œæ‰‹æœºå·ç ç»‘å®šæˆ–éªŒè¯
3. **æ–°ç”¨æˆ·é»˜è®¤æœªå¼€å¯ SMTP æœåŠ¡**ï¼Œç™»å½•ç½‘é¡µç‰ˆè¿›è¡Œèº«ä»½éªŒè¯åå°†è‡ªåŠ¨å¼€å¯
4. IMAP æœåŠ¡ä¸€èˆ¬é»˜è®¤å¼€å¯

### IMAP/SMTP æœåŠ¡å™¨é…ç½®

| æœåŠ¡ | æœåŠ¡å™¨åœ°å€ | ç«¯å£ | åŠ å¯†æ–¹å¼ |
|------|-----------|------|----------|
| IMAP | imap-ent.21cn.com | 993 | SSL |
| POP3 | pop-ent.21cn.com | 995 | SSL |
| SMTP | smtp-ent.21cn.com | 465 | SSL |

## é¡¹ç›®æ¶æ„

```
ä¾›åº”å•†é‚®ä»¶ç¿»è¯‘ç³»ç»Ÿ/
â”œâ”€â”€ backend/                 # FastAPI åç«¯ï¼ˆæœåŠ¡å™¨éƒ¨ç½²ï¼‰
â”‚   â”œâ”€â”€ main.py             # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ config.py           # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ celery_app.py       # Celery å¼‚æ­¥ä»»åŠ¡é…ç½®
â”‚   â”œâ”€â”€ websocket.py        # WebSocket è¿æ¥ç®¡ç†
â”‚   â”œâ”€â”€ database/           # æ•°æ®åº“å±‚
â”‚   â”‚   â”œâ”€â”€ database.py     # MySQL å¼‚æ­¥è¿æ¥
â”‚   â”‚   â”œâ”€â”€ models.py       # SQLAlchemy æ•°æ®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ crud.py         # æ•°æ®æ“ä½œå‡½æ•°
â”‚   â”œâ”€â”€ routers/            # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ users.py        # é‚®ç®±ç™»å½•è®¤è¯
â”‚   â”‚   â”œâ”€â”€ emails.py       # é‚®ä»¶ç®¡ç†ï¼ˆå«æ‰¹é‡æ“ä½œï¼‰
â”‚   â”‚   â”œâ”€â”€ translate.py    # ç¿»è¯‘æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ approval.py     # è‰ç¨¿ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ suppliers.py    # ä¾›åº”å•†ç®¡ç†
â”‚   â”‚   â””â”€â”€ tasks.py        # å¼‚æ­¥ä»»åŠ¡çŠ¶æ€
â”‚   â”œâ”€â”€ tasks/              # Celery ä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ translate_tasks.py  # ç¿»è¯‘ä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ email_tasks.py      # é‚®ä»¶ä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ ai_tasks.py         # AI æå–ä»»åŠ¡
â”‚   â”‚   â””â”€â”€ maintenance_tasks.py # å®šæ—¶ç»´æŠ¤
â”‚   â””â”€â”€ services/           # ä¸šåŠ¡æœåŠ¡
â”‚       â”œâ”€â”€ email_service.py        # IMAP/SMTP é‚®ä»¶æ”¶å‘
â”‚       â”œâ”€â”€ translate_service.py    # ç¿»è¯‘å¼•æ“
â”‚       â””â”€â”€ notification_service.py # WebSocket æ¨é€
â”œâ”€â”€ frontend/               # Vue3 + Electron å‰ç«¯ï¼ˆæ¡Œé¢å®¢æˆ·ç«¯ï¼‰
â”‚   â”œâ”€â”€ electron/           # Electron ä¸»è¿›ç¨‹
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ views/          # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ api/            # API å°è£…
â”‚   â”‚   â”œâ”€â”€ stores/         # Pinia çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ utils/          # å·¥å…·å‡½æ•°
â”‚   â”‚   â”‚   â””â”€â”€ websocket.js # WebSocket å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ router/         # Vue Router
â”‚   â””â”€â”€ package.json        # ä¾èµ–ä¸æ„å»ºé…ç½®
â””â”€â”€ backend/.env            # åç«¯é…ç½®ï¼ˆMySQLã€ç¿»è¯‘APIç­‰ï¼‰
```

## æŠ€æœ¯æ ˆ

| å±‚ | æŠ€æœ¯ |
|---|------|
| åç«¯ | FastAPI (Python 3.10+) |
| æ•°æ®åº“ | MySQL (æœåŠ¡å™¨å…±äº«) |
| ç¼“å­˜ | Redis (L1ç¼“å­˜ + æ¶ˆæ¯é˜Ÿåˆ—) |
| ORM | SQLAlchemy 2.0 (async) + aiomysql |
| å¼‚æ­¥ä»»åŠ¡ | Celery + Redis |
| å®æ—¶æ¨é€ | WebSocket (FastAPI + å‰ç«¯) |
| è®¤è¯ | JWT (é‚®ç®±IMAPéªŒè¯) |
| å‰ç«¯ | Vue 3 + Vite + Element Plus |
| æ¡Œé¢ç«¯ | Electron 28 |
| ç¿»è¯‘ | Ollama (æœ¬åœ°) / Claude API |

## æ ¸å¿ƒåŠŸèƒ½

1. **é‚®ç®±ç™»å½•** - ä½¿ç”¨å…¬å¸é‚®ç®±å¯†ç éªŒè¯IMAPè¿æ¥
2. **é‚®ä»¶æ”¶å–** - IMAPåè®®æ‹‰å–é‚®ä»¶ï¼Œè‡ªåŠ¨æ£€æµ‹è¯­è¨€
3. **æ™ºèƒ½ç¿»è¯‘** - å¤–è¯­é‚®ä»¶ç¿»è¯‘ä¸ºä¸­æ–‡ï¼ˆOllama/Claudeï¼‰
4. **å›å¤æ’°å†™** - ä¸­æ–‡æ’°å†™ï¼Œç¿»è¯‘ä¸ºç›®æ ‡è¯­è¨€å‘é€
5. **å®¡æ‰¹æµç¨‹** - è‰ç¨¿æäº¤å®¡æ‰¹ï¼Œå®¡æ‰¹äººå®¡æ ¸åå‘é€
6. **æœ¯è¯­è¡¨** - æŒ‰ä¾›åº”å•†ç»´æŠ¤ä¸“ä¸šæœ¯è¯­ç¿»è¯‘

## å®¡æ‰¹åŠŸèƒ½

### å®¡æ‰¹æµç¨‹

```
ä½œè€…æ’°å†™è‰ç¨¿ â†’ ç¿»è¯‘ â†’ æäº¤å®¡æ‰¹ï¼ˆé€‰æ‹©å®¡æ‰¹äººï¼‰
                           â†“
                    å®¡æ‰¹äººæ”¶åˆ°å¾…å®¡æ‰¹åˆ—è¡¨
                           â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“            â†“            â†“
           ç›´æ¥é€šè¿‡    ä¿®æ”¹åé€šè¿‡      é©³å›
           (å‘é€é‚®ä»¶)  (ä¿®æ”¹+å‘é€)  (è¿”å›ä¿®æ”¹)
```

### è®¾ç½®é»˜è®¤å®¡æ‰¹äºº

åœ¨ **è®¾ç½®é¡µé¢ â†’ å®¡æ‰¹è®¾ç½®** ä¸­å¯ä»¥é…ç½®é»˜è®¤å®¡æ‰¹äººï¼Œæäº¤å®¡æ‰¹æ—¶ä¼šè‡ªåŠ¨é€‰æ‹©ã€‚

### å®¡æ‰¹ç›¸å…³ API

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/drafts` | POST | åˆ›å»ºè‰ç¨¿ |
| `/api/drafts/{id}/send` | POST | æäº¤å®¡æ‰¹ |
| `/api/drafts/{id}/approve` | POST | å®¡æ‰¹é€šè¿‡å¹¶å‘é€ |
| `/api/drafts/{id}/reject` | POST | é©³å› |
| `/api/drafts/pending` | GET | è·å–å¾…å®¡æ‰¹åˆ—è¡¨ |
| `/api/users/approvers` | GET | è·å–å¯é€‰å®¡æ‰¹äºº |
| `/api/users/me/default-approver` | PUT | è®¾ç½®é»˜è®¤å®¡æ‰¹äºº |

## å¼€å‘å‘½ä»¤

```bash
# åç«¯
cd backend
pip install -r requirements.txt
uvicorn main:app --reload --port 8000

# å‰ç«¯
cd frontend
npm install
npm run dev              # æµè§ˆå™¨å¼€å‘
npm run electron:dev     # Electron å¼€å‘
npm run electron:build   # æ‰“åŒ… Windows å®‰è£…åŒ…
```

## æ‰“åŒ…å‘å¸ƒ

### ä¸€é”®æ‰“åŒ…

åŒå‡»é¡¹ç›®æ ¹ç›®å½•çš„ `build.bat` å³å¯è‡ªåŠ¨å®Œæˆæ‰“åŒ…ï¼Œç”Ÿæˆç‹¬ç«‹å®‰è£…ç¨‹åºã€‚

### æ‰‹åŠ¨æ‰“åŒ…æ­¥éª¤

```bash
# 1. æ‰“åŒ…åç«¯ (ç”Ÿæˆ backend/dist/backend.exe)
cd backend
pip install pyinstaller
python -m PyInstaller backend.spec --noconfirm

# 2. æ„å»ºå‰ç«¯èµ„æº
cd frontend
npm install
npm run build

# 3. æ‰“åŒ… Electron åº”ç”¨
npx electron-builder --win
```

### æ‰“åŒ…äº§ç‰©

- **å®‰è£…ç¨‹åº**: `frontend/dist_electron/ä¾›åº”å•†é‚®ä»¶ç¿»è¯‘ç³»ç»Ÿ Setup 1.0.0.exe`
- **å…å®‰è£…ç‰ˆ**: `frontend/dist_electron/win-unpacked/`

### æ‰“åŒ…é…ç½®æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `backend/backend.spec` | PyInstaller æ‰“åŒ…é…ç½® |
| `frontend/package.json` (buildå­—æ®µ) | electron-builder é…ç½® |
| `build.bat` | ä¸€é”®æ‰“åŒ…è„šæœ¬ |

### è¿è¡Œæœºåˆ¶

**æœåŠ¡å™¨ç»Ÿä¸€éƒ¨ç½²æ¶æ„**ï¼ˆ2024å¹´12æœˆæ›´æ–°ï¼‰ï¼š
1. åç«¯æœåŠ¡éƒ¨ç½²åœ¨æœåŠ¡å™¨ `jzchardware.cn:8888`
2. ç”¨æˆ·ç‚¹å‡»å¿«æ·æ–¹å¼å¯åŠ¨ Electron åº”ç”¨
3. Electron æ˜¾ç¤ºå¯åŠ¨ç”»é¢ï¼Œç­‰å¾…æœåŠ¡å™¨å¥åº·æ£€æŸ¥é€šè¿‡
4. æ£€æŸ¥é€šè¿‡åæ˜¾ç¤ºä¸»ç•Œé¢ï¼Œç›´æ¥è¿æ¥æœåŠ¡å™¨ API
5. æ‰€æœ‰ç”¨æˆ·å…±äº«åŒä¸€ä¸ªåç«¯æœåŠ¡

**API åœ°å€**ï¼š
- å¼€å‘ç¯å¢ƒï¼š`http://127.0.0.1:2000/api`
- ç”Ÿäº§ç¯å¢ƒï¼š`https://jzchardware.cn:8888/email/api`

## ç«¯å£é…ç½®

| æœåŠ¡ | é»˜è®¤ç«¯å£ | ç¯å¢ƒå˜é‡ |
|------|----------|----------|
| åç«¯ APIï¼ˆå¼€å‘ï¼‰ | 2000 | `BACKEND_PORT` |
| åç«¯ APIï¼ˆç”Ÿäº§ï¼‰ | 8888 | æœåŠ¡å™¨å›ºå®š |
| å‰ç«¯å¼€å‘ | 4567 | `VITE_PORT` |

## å¯åŠ¨å®‰å…¨æœºåˆ¶

å‰ç«¯å¯åŠ¨è„šæœ¬åŒ…å«ä»¥ä¸‹å®‰å…¨æªæ–½ï¼š
- `vite.config.js` è®¾ç½® `strictPort: true`ï¼šç«¯å£è¢«å ç”¨æ—¶ç›´æ¥å¤±è´¥ï¼Œä¸ä¼šè‡ªåŠ¨åˆ‡æ¢ç«¯å£
- `package.json` çš„ `electron:dev` ä½¿ç”¨ `--kill-others-on-fail`ï¼švite å¯åŠ¨å¤±è´¥æ—¶è‡ªåŠ¨ç»ˆæ­¢ electron
- å¯åŠ¨å‰åº”ç¡®ä¿ç«¯å£æœªè¢«å ç”¨ï¼Œå¦åˆ™æ•´ä¸ªå¯åŠ¨è¿‡ç¨‹ä¼šå¤±è´¥å¹¶é€€å‡º

**âš ï¸ é‡è¦ï¼šä¸è¦éšæ„æ›´æ”¹ç«¯å£é…ç½®ï¼**

å¦‚æœç«¯å£è¢«å ç”¨ï¼ˆå¦‚ 4567 æˆ– 8000ï¼‰ï¼Œæ­£ç¡®çš„åšæ³•æ˜¯ï¼š
1. æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹ï¼š`netstat -ano | findstr :4567`
2. ç»ˆæ­¢è¯¥è¿›ç¨‹ï¼š`taskkill /PID <è¿›ç¨‹ID> /F`
3. é‡æ–°å¯åŠ¨åº”ç”¨

**é”™è¯¯åšæ³•**ï¼šä¿®æ”¹ç«¯å£å·ï¼ˆå¦‚æ”¹æˆ 5678ï¼‰â€”â€” è¿™ä¼šå¯¼è‡´é…ç½®æ··ä¹±ï¼Œå‰åç«¯ç«¯å£ä¸ä¸€è‡´

## ç¯å¢ƒé…ç½®

åˆ›å»º `backend/.env`ï¼š

```env
# ===== MySQL æ•°æ®åº“é…ç½®ï¼ˆæœåŠ¡å™¨å…±äº«ï¼‰=====
MYSQL_HOST=61.145.212.28
MYSQL_PORT=3306
MYSQL_USER=email_user
MYSQL_PASSWORD=your-password
MYSQL_DATABASE=email_translate

# ===== ç¿»è¯‘å¼•æ“é…ç½® =====
# ollama: æœ¬åœ°å¤§æ¨¡å‹ï¼ˆä¸»åŠ›ï¼Œå…è´¹ï¼‰
# claude: Claude APIï¼ˆå¤æ‚é‚®ä»¶å¤‡ç”¨ï¼‰
TRANSLATE_PROVIDER=ollama

# Ollama æœ¬åœ°æ¨¡å‹ - ä¸»åŠ›ç¿»è¯‘å¼•æ“
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=qwen3:8b

# Claude API (Anthropic) - å¤æ‚é‚®ä»¶å¤‡ç”¨
CLAUDE_API_KEY=your-claude-api-key
CLAUDE_MODEL=claude-sonnet-4-20250514

# JWT å¯†é’¥
SECRET_KEY=your-secret-key
```

### ç¿»è¯‘å¼•æ“é…ç½®

| Provider | è¯´æ˜ | è´¹ç”¨ | ç”¨é‡ç»Ÿè®¡ |
|----------|------|------|----------|
| `ollama` | æœ¬åœ°å¤§æ¨¡å‹ï¼ˆä¸»åŠ›ï¼‰ | å…è´¹ | ä¸ç»Ÿè®¡ |
| `claude` | Claude APIï¼ˆå¤æ‚é‚®ä»¶å¤‡ç”¨ï¼‰ | æŒ‰é‡ä»˜è´¹ | âœ“ è‡ªåŠ¨è®°å½• |

### æ™ºèƒ½è·¯ç”±æ¨¡å¼ï¼ˆæ¨èï¼‰

è®¾ç½® `SMART_ROUTING_ENABLED=true`ï¼ˆé»˜è®¤å¯ç”¨ï¼‰ï¼Œç³»ç»ŸåŸºäºé‚®ä»¶å¤æ‚åº¦è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å¼•æ“ï¼š

```
é‚®ä»¶è¿›å…¥
    â†“
Ollama è¯„ä¼°å¤æ‚åº¦ï¼ˆè§„åˆ™ä¼˜å…ˆï¼Œå¿…è¦æ—¶ç”¨LLMæ‰“åˆ†ï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç®€å•(â‰¤50åˆ†)     â”‚ ä¸­ç­‰(51-70)          â”‚ å¤æ‚(>70)           â”‚
â”‚                 â”‚                      â”‚                     â”‚
â”‚ Ollamaç›´æ¥ç¿»è¯‘  â”‚ Ollamaæ‹†åˆ†é‚®ä»¶ç»“æ„   â”‚ Ollamaæ‹†åˆ†é‚®ä»¶ç»“æ„  â”‚
â”‚ (å…è´¹å¿«é€Ÿ)      â”‚ â”œâ”€ æ­£æ–‡ â†’ Ollama     â”‚ â”œâ”€ æ­£æ–‡ â†’ Claude    â”‚
â”‚                 â”‚ â””â”€ ç­¾å â†’ Ollama     â”‚ â””â”€ ç­¾å â†’ Ollama    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ å¤±è´¥æ—¶è‡ªåŠ¨å›é€€
Ollama â†’ Claude
```

**æ™ºèƒ½æ‹†åˆ†ç¿»è¯‘**ï¼š
- Ollama ä½¿ç”¨ `/think` æ¨¡å¼åˆ†æé‚®ä»¶ç»“æ„ï¼Œè¯†åˆ«é—®å€™è¯­ã€æ­£æ–‡ã€ç­¾å
- å¤æ‚é‚®ä»¶æ­£æ–‡ä½¿ç”¨ Claudeï¼ˆç†è§£èƒ½åŠ›å¼ºï¼‰
- é—®å€™è¯­ã€ç­¾åç­‰å›ºå®šæ ¼å¼å†…å®¹ä½¿ç”¨ Ollamaï¼ˆå…è´¹ã€æ ¼å¼ä¿æŒå¥½ï¼‰
- Ollama è¶…æ—¶ 600 ç§’ï¼Œnum_predict=4096 æ”¯æŒé•¿æ–‡æœ¬

**å¤æ‚åº¦åˆ¤æ–­æ ‡å‡†**ï¼š
- ç®€å•ï¼š<500å­—ç¬¦ï¼Œæ— è¡¨æ ¼/åˆ—è¡¨ï¼Œæ—¥å¸¸é—®å€™ç¡®è®¤
- ä¸­ç­‰ï¼šä¸€èˆ¬ä¸šåŠ¡é‚®ä»¶ï¼Œå¤šä¸ªäº‹é¡¹
- å¤æ‚ï¼šæŠ€æœ¯æ–‡æ¡£ã€åˆåŒæ¡æ¬¾ã€è¡¨æ ¼æ•°æ®ã€å¤šå±‚åµŒå¥—

**ç”¨é‡ä¿æŠ¤**ï¼š
- 80% ç”¨é‡æ—¶å‘å‡ºè­¦å‘Š
- 95% ç”¨é‡æ—¶è‡ªåŠ¨ç¦ç”¨ï¼ˆé˜²æ­¢è¶…é¢æ”¶è´¹ï¼‰
- æ¯æœˆ1æ—¥è‡ªåŠ¨é‡ç½®

### ç”¨é‡ç»Ÿè®¡ API

| ç«¯ç‚¹ | è¯´æ˜ |
|------|------|
| GET /api/translate/usage-stats | è·å–æ‰€æœ‰å¼•æ“ç”¨é‡ |
| GET /api/translate/usage-stats/{provider} | è·å–æŒ‡å®šå¼•æ“ç”¨é‡ |
| POST /api/translate/usage-stats/{provider}/reset | é‡æ–°å¯ç”¨è¢«ç¦ç”¨çš„å¼•æ“ |

åˆ›å»º `frontend/.env`ï¼ˆå¯é€‰ï¼‰ï¼š

```env
VITE_PORT=3456
VITE_API_URL=http://localhost:8000/api
```

## API ç«¯ç‚¹

| æ–¹æ³• | ç«¯ç‚¹ | è¯´æ˜ |
|------|------|------|
| POST | /api/users/login | é‚®ç®±ç™»å½• |
| GET | /api/users/me | è·å–å½“å‰è´¦æˆ· |
| GET | /api/emails | é‚®ä»¶åˆ—è¡¨ï¼ˆæ”¯æŒ search/sort_by/supplier_id/direction å‚æ•°ï¼‰ |
| GET | /api/emails/{id} | é‚®ä»¶è¯¦æƒ… |
| POST | /api/emails/fetch | æ‹‰å–æ–°é‚®ä»¶ |
| PATCH | /api/emails/{id}/read | æ ‡è®°å·²è¯» |
| PATCH | /api/emails/{id}/unread | æ ‡è®°æœªè¯» |
| PATCH | /api/emails/{id}/flag | æ·»åŠ æ˜Ÿæ ‡ |
| PATCH | /api/emails/{id}/unflag | å–æ¶ˆæ˜Ÿæ ‡ |
| POST | /api/emails/{id}/translate | ç¿»è¯‘å•ä¸ªé‚®ä»¶ |
| DELETE | /api/emails/{id} | åˆ é™¤é‚®ä»¶ |
| POST | /api/emails/batch/read | æ‰¹é‡æ ‡è®°å·²è¯» |
| POST | /api/emails/batch/unread | æ‰¹é‡æ ‡è®°æœªè¯» |
| POST | /api/emails/batch/delete | æ‰¹é‡åˆ é™¤ |
| GET | /api/emails/stats/summary | é‚®ä»¶ç»Ÿè®¡ |
| GET | /api/emails/thread/{thread_id} | è·å–é‚®ä»¶çº¿ç¨‹ |
| GET | /api/emails/contacts | è·å–å†å²è”ç³»äººï¼ˆæŒ‰é¢‘ç‡æ’åºï¼‰ |
| POST | /api/translate | ç¿»è¯‘æ–‡æœ¬ |
| POST | /api/translate/reverse | å›å¤ç¿»è¯‘ï¼ˆä¸­â†’å¤–ï¼‰ |
| GET | /api/drafts | è·å–è‰ç¨¿ |
| POST | /api/drafts | åˆ›å»ºè‰ç¨¿ |
| POST | /api/drafts/{id}/send | å‘é€è‰ç¨¿ |
| GET | /api/suppliers | ä¾›åº”å•†åˆ—è¡¨ |
| GET | /api/translate/glossary/{id} | æœ¯è¯­è¡¨ |
| GET | /api/labels | è·å–æ ‡ç­¾åˆ—è¡¨ |
| POST | /api/labels | åˆ›å»ºæ ‡ç­¾ |
| PUT | /api/labels/{id} | æ›´æ–°æ ‡ç­¾ |
| DELETE | /api/labels/{id} | åˆ é™¤æ ‡ç­¾ |
| POST | /api/labels/emails/{email_id} | ä¸ºé‚®ä»¶æ·»åŠ æ ‡ç­¾ |
| DELETE | /api/labels/emails/{email_id} | ç§»é™¤é‚®ä»¶æ ‡ç­¾ |
| GET | /api/folders | è·å–æ–‡ä»¶å¤¹æ ‘ |
| POST | /api/folders | åˆ›å»ºæ–‡ä»¶å¤¹ |
| PUT | /api/folders/{id} | æ›´æ–°æ–‡ä»¶å¤¹ |
| DELETE | /api/folders/{id} | åˆ é™¤æ–‡ä»¶å¤¹ |
| POST | /api/folders/{id}/emails | æ·»åŠ é‚®ä»¶åˆ°æ–‡ä»¶å¤¹ |
| DELETE | /api/folders/{id}/emails/{email_id} | ä»æ–‡ä»¶å¤¹ç§»é™¤é‚®ä»¶ |
| GET | /api/folders/{id}/emails | è·å–æ–‡ä»¶å¤¹ä¸­çš„é‚®ä»¶ |
| GET | /api/calendar/events | è·å–æ—¥å†äº‹ä»¶ï¼ˆæ”¯æŒ start/end æ—¶é—´è¿‡æ»¤ï¼‰ |
| POST | /api/calendar/events | åˆ›å»ºæ—¥å†äº‹ä»¶ |
| GET | /api/calendar/events/{id} | è·å–å•ä¸ªäº‹ä»¶è¯¦æƒ… |
| PUT | /api/calendar/events/{id} | æ›´æ–°æ—¥å†äº‹ä»¶ |
| DELETE | /api/calendar/events/{id} | åˆ é™¤æ—¥å†äº‹ä»¶ |
| POST | /api/calendar/events/from-email/{email_id} | ä»é‚®ä»¶åˆ›å»ºäº‹ä»¶ |
| GET | /api/calendar/events/by-email/{email_id} | è·å–é‚®ä»¶å…³è”çš„äº‹ä»¶ |
| POST | /api/ai/extract/{email_id} | AI æå–é‚®ä»¶ä¿¡æ¯ï¼ˆforce=true å¼ºåˆ¶é‡æ–°æå–ï¼‰ |
| GET | /api/ai/extract/{email_id} | è·å–å·²æå–çš„ä¿¡æ¯ |
| DELETE | /api/ai/extract/{email_id} | åˆ é™¤æå–ç»“æœ |
| WS | /ws/{account_id} | WebSocket å®æ—¶æ¨é€è¿æ¥ |

## æ•°æ®æ¨¡å‹

- **EmailAccount** - é‚®ç®±è´¦æˆ·ï¼ˆIMAP/SMTPé…ç½®ï¼Œç™»å½•åè‡ªåŠ¨åˆ›å»ºï¼‰
- **Email** - é‚®ä»¶ï¼ˆåŸæ–‡ã€è¯‘æ–‡ã€è¯­è¨€æ£€æµ‹ã€is_readã€is_flaggedã€labelsã€foldersï¼‰
- **Supplier** - ä¾›åº”å•†ï¼ˆåŸŸåã€è”ç³»é‚®ç®±ï¼‰
- **Glossary** - æœ¯è¯­è¡¨ï¼ˆåŸæ–‡â†’è¯‘æ–‡ï¼‰
- **Draft** - å›å¤è‰ç¨¿ï¼ˆä¸­æ–‡ã€è¯‘æ–‡ã€çŠ¶æ€ï¼‰
- **EmailLabel** - é‚®ä»¶æ ‡ç­¾ï¼ˆnameã€colorã€account_idï¼‰
- **EmailFolder** - è‡ªå®šä¹‰æ–‡ä»¶å¤¹ï¼ˆæ”¯æŒåµŒå¥—ï¼Œparent_idï¼‰
- **CalendarEvent** - æ—¥å†äº‹ä»¶ï¼ˆtitleã€start_timeã€end_timeã€å¯å…³è”é‚®ä»¶ï¼‰
- **EmailExtraction** - AI æå–ç»“æœï¼ˆsummaryã€datesã€amountsã€contactsã€action_itemsï¼‰

### æ•°æ®åº“è¿ç§»

å¦‚æœæ•°æ®åº“å·²å­˜åœ¨ï¼Œéœ€è¦è¿è¡Œè¿ç§»è„šæœ¬æ·»åŠ æ–°å­—æ®µï¼š
```bash
cd backend
python -m migrations.add_email_flags
python -m migrations.add_email_labels
python -m migrations.add_email_folders
python -m migrations.add_calendar_events
```

## å®‰å…¨æœºåˆ¶

### ç™»å½•çŠ¶æ€å­˜å‚¨

ç™»å½•çŠ¶æ€é€šè¿‡ JWT token ä¿å­˜åœ¨ Electron çš„ localStorage ä¸­ï¼š

```
%APPDATA%\supplier-email-translator\
â”œâ”€â”€ Local Storage/          # localStorage æ•°æ®ï¼ˆåŒ…å« JWT tokenï¼‰
â”œâ”€â”€ data/                   # åº”ç”¨æ•°æ®
â””â”€â”€ ...
```

**é‡è¦è¯´æ˜**ï¼š
- Token æœ‰æ•ˆæœŸä¸º 7 å¤©
- å¸è½½è½¯ä»¶æ—¶ï¼Œç”¨æˆ·æ•°æ®ä¼šè¢«è‡ªåŠ¨æ¸…ç†ï¼ˆ`deleteAppDataOnUninstall: true`ï¼‰
- ç”¨æˆ·å¯é€šè¿‡å·¦ä¸‹è§’"é€€å‡ºç™»å½•"æŒ‰é’®ä¸»åŠ¨æ¸…é™¤ç™»å½•çŠ¶æ€

### é€€å‡ºç™»å½•

ç‚¹å‡»å·¦ä¾§å¯¼èˆªæ åº•éƒ¨çš„"é€€å‡ºç™»å½•"æŒ‰é’®ï¼š
1. æ¸…é™¤ localStorage ä¸­çš„ tokenã€emailã€accountId
2. åœæ­¢è‡ªåŠ¨æ‹‰å–é‚®ä»¶å®šæ—¶å™¨
3. è·³è½¬åˆ°ç™»å½•é¡µé¢

### å®‰å…¨å»ºè®®

| é£é™© | è¯´æ˜ | ç¼“è§£æªæ–½ |
|------|------|----------|
| æœ¬æœºå…±äº« | åŒä¸€å°ç”µè„‘çš„å…¶ä»– Windows ç”¨æˆ·å¯èƒ½è®¿é—® AppData | ä½¿ç”¨ Windows è´¦æˆ·éš”ç¦» |
| è®¾å¤‡ä¸¢å¤± | ç”µè„‘ä¸¢å¤±åæ— éœ€å¯†ç å³å¯è®¿é—® | å¯ç”¨ Windows ç™»å½•å¯†ç  + ç¡¬ç›˜åŠ å¯† |
| å…¬å…±ç”µè„‘ | åœ¨å…¬å…±ç”µè„‘ä¸Šä½¿ç”¨åå¿˜è®°é€€å‡º | ä½¿ç”¨å®Œæ¯•åç‚¹å‡»"é€€å‡ºç™»å½•" |

### ç›¸å…³é…ç½®

```json
// frontend/package.json - NSIS é…ç½®
"nsis": {
  "deleteAppDataOnUninstall": true  // å¸è½½æ—¶æ¸…ç†ç”¨æˆ·æ•°æ®
}
```

## æ³¨æ„äº‹é¡¹

- é¦–æ¬¡è¿è¡Œè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¡¨
- ä»…å…è®¸ `@jingzhicheng.com.cn` é‚®ç®±ç™»å½•
- é‚®ç®±å¯†ç å­˜å‚¨åœ¨æ•°æ®åº“ï¼ˆå»ºè®®å®ç°åŠ å¯†ï¼‰
- Windows æ‰“åŒ…äº§ç‰©åœ¨ `frontend/dist_electron/`

## æ•°æ®åº“æ¶æ„

æ‰€æœ‰æ¡Œé¢ç«¯è¿æ¥æœåŠ¡å™¨ä¸Šçš„ MySQLï¼Œå®ç°ç¿»è¯‘ç»“æœå…±äº«ï¼š

```
ç”¨æˆ· A ç”µè„‘                      æœåŠ¡å™¨ (61.145.212.28)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Electron åº”ç”¨ â”‚                â”‚     MySQL       â”‚
â”‚ + backend.exe â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ email_translate â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â†‘
ç”¨æˆ· B ç”µè„‘                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚ Electron åº”ç”¨ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ + backend.exe â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…±äº«çš„æ•°æ®è¡¨**ï¼š
| è¡¨ | è¯´æ˜ |
|---|------|
| `translation_cache` | ç¿»è¯‘ç¼“å­˜ï¼ˆç›¸åŒæ–‡æœ¬åªç¿»è¯‘ä¸€æ¬¡ï¼‰ |
| `shared_email_translations` | é‚®ä»¶ç¿»è¯‘å…±äº«ï¼ˆåŒä¸€å°é‚®ä»¶åªç¿»è¯‘ä¸€æ¬¡ï¼‰ |
| `email_accounts` | ç”¨æˆ·é‚®ç®±è´¦æˆ· |
| `emails` | é‚®ä»¶æ•°æ® |
| `suppliers` | ä¾›åº”å•†ä¿¡æ¯ |
| `glossaries` | æœ¯è¯­è¡¨ |
| `drafts` | è‰ç¨¿ |

## MySQL æœåŠ¡å™¨éƒ¨ç½²

### æœåŠ¡å™¨ä¿¡æ¯

- **æœåŠ¡å™¨åœ°å€**: 61.145.212.28 (jzchardware.cn)
- **MySQL ç«¯å£**: 3306
- **æ•°æ®åº“å**: email_translate

### åˆå§‹åŒ–æ•°æ®åº“

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE email_translate CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- åˆ›å»ºç”¨æˆ·å¹¶æˆæƒ
CREATE USER 'email_user'@'%' IDENTIFIED BY 'your-secure-password';
GRANT ALL PRIVILEGES ON email_translate.* TO 'email_user'@'%';
FLUSH PRIVILEGES;
```

### é˜²ç«å¢™é…ç½®

ç¡®ä¿æœåŠ¡å™¨å¼€æ”¾ 3306 ç«¯å£ä¾›å†…ç½‘è®¿é—®ï¼š

```bash
# å¦‚æœä½¿ç”¨ firewalld
firewall-cmd --permanent --add-port=3306/tcp
firewall-cmd --reload
```

### éªŒè¯è¿æ¥

```bash
mysql -h 61.145.212.28 -u email_user -p email_translate
```

## ç¿»è¯‘ä¼˜åŒ–æœºåˆ¶

ä¸ºèŠ‚çœç¿»è¯‘ API è°ƒç”¨ï¼Œç³»ç»Ÿå®ç°äº†ä¸‰çº§ç¼“å­˜æœºåˆ¶ï¼š

```
ç¿»è¯‘è¯·æ±‚ â†’ Redis(L1) â†’ MySQL(L2) â†’ ç¿»è¯‘API
              â†‘            â†‘           â†“
           ~1ms         ~10ms      ~500ms+
              â””â”€ çƒ­ç‚¹æ•°æ® â”€â”˜  â† å†™å…¥ç¼“å­˜
```

### 0. Redis ç¼“å­˜ (L1)

å†…å­˜çº§ç¼“å­˜ï¼Œæ¯«ç§’å“åº”ï¼Œé€‚åˆçƒ­ç‚¹æ•°æ®ï¼š

```bash
# æœåŠ¡å™¨é…ç½®ï¼ˆå®å¡”é¢æ¿å®‰è£…æˆ–æ‰‹åŠ¨å®‰è£…ï¼‰
yum install redis -y && systemctl start redis && systemctl enable redis

# .env é…ç½®
REDIS_URL=redis://localhost:6379/0
CACHE_DEFAULT_TTL=3600
CACHE_PREFIX=email_translate
```

**ç‰¹æ€§**ï¼š
- ä½¿ç”¨ `shared/cache_config.py` æ¨¡å—
- **Graceful é™çº§**ï¼šRedis ä¸å¯ç”¨æ—¶è‡ªåŠ¨å›é€€åˆ° MySQL ç¼“å­˜
- TTL é»˜è®¤ 1 å°æ—¶

### 1. ç¿»è¯‘ç¼“å­˜è¡¨ - TranslationCache (L2)

å¯¹ç¿»è¯‘ç»“æœè¿›è¡ŒæŒä¹…åŒ–ç¼“å­˜ï¼Œç›¸åŒæ–‡æœ¬åªç¿»è¯‘ä¸€æ¬¡ï¼š

```
TranslationCache
â”œâ”€â”€ text_hash      # åŸæ–‡ SHA256ï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰
â”œâ”€â”€ source_text    # åŸæ–‡
â”œâ”€â”€ translated_text # è¯‘æ–‡
â”œâ”€â”€ source_lang    # æºè¯­è¨€
â”œâ”€â”€ target_lang    # ç›®æ ‡è¯­è¨€
â””â”€â”€ hit_count      # ç¼“å­˜å‘½ä¸­æ¬¡æ•°
```

**å·¥ä½œæµç¨‹**ï¼š
1. ç¿»è¯‘è¯·æ±‚ â†’ è®¡ç®—åŸæ–‡ hash
2. æŸ¥ Redis(L1) â†’ å‘½ä¸­ç›´æ¥è¿”å›
3. æœªå‘½ä¸­ â†’ æŸ¥ MySQL(L2) â†’ å‘½ä¸­åˆ™å†™å› Redis å¹¶è¿”å›
4. éƒ½æœªå‘½ä¸­ â†’ è°ƒç”¨ç¿»è¯‘ API â†’ åŒæ—¶å†™å…¥ Redis + MySQL

**æ•ˆæœ**ï¼šç­¾åã€å§“åã€å¸¸ç”¨è¯­å¥ç­‰é‡å¤å†…å®¹åªç¿»è¯‘ä¸€æ¬¡

### 2. é‚®ä»¶ç¿»è¯‘å…±äº«è¡¨ (SharedEmailTranslation)

åŸºäºé‚®ä»¶ Message-ID å…±äº«ç¿»è¯‘ç»“æœï¼ŒåŒä¸€å°é‚®ä»¶åœ¨å…¬å¸å†…åªç¿»è¯‘ä¸€æ¬¡ï¼š

```
SharedEmailTranslation
â”œâ”€â”€ message_id          # é‚®ä»¶ RFC Message-IDï¼ˆå”¯ä¸€ï¼‰
â”œâ”€â”€ subject_translated  # ä¸»é¢˜è¯‘æ–‡
â”œâ”€â”€ body_translated     # æ­£æ–‡è¯‘æ–‡
â”œâ”€â”€ translated_by       # ç¿»è¯‘è§¦å‘è€…
â””â”€â”€ translated_at       # ç¿»è¯‘æ—¶é—´
```

**å·¥ä½œæµç¨‹**ï¼š
1. ç”¨æˆ· A ç¿»è¯‘é‚®ä»¶ â†’ å­˜å…¥å…±äº«è¡¨
2. ç”¨æˆ· B æŸ¥çœ‹åŒä¸€å°é‚®ä»¶ â†’ æ£€æŸ¥å…±äº«è¡¨ â†’ æœ‰è¯‘æ–‡ç›´æ¥å¤ç”¨

**æ•ˆæœ**ï¼š`@jingzhicheng.com.cn` çš„æ‰€æœ‰ç”¨æˆ·å…±äº«ç¿»è¯‘ç»“æœ

### ç¼“å­˜ç»Ÿè®¡ API

| ç«¯ç‚¹ | è¯´æ˜ |
|------|------|
| GET /api/translate/cache/stats | è·å–ç¼“å­˜å‘½ä¸­ç»Ÿè®¡ |
| DELETE /api/translate/cache | æ¸…ç©ºç¿»è¯‘ç¼“å­˜ |

### 3. è‡ªåŠ¨ç¿»è¯‘è§¦å‘

é‚®ä»¶æ‹‰å–æ—¶è‡ªåŠ¨ç¿»è¯‘éä¸­æ–‡é‚®ä»¶ï¼Œæµç¨‹ï¼š

```
POST /api/emails/fetch
       â†“
fetch_emails_background() åå°ä»»åŠ¡
       â†“
æ‹‰å–é‚®ä»¶ â†’ æ£€æµ‹è¯­è¨€ â†’ éä¸­æ–‡? â†’ è‡ªåŠ¨ç¿»è¯‘ â†’ å­˜å…¥å…±äº«è¡¨
                          â†“
              æ‰€æœ‰ç”¨æˆ·ç›´æ¥çœ‹åˆ°ç¿»è¯‘ç»“æœ
```

**è‡ªåŠ¨ç¿»è¯‘é€»è¾‘**ï¼š
1. é‚®ä»¶æ‹‰å–åæ£€æµ‹è¯­è¨€
2. éä¸­æ–‡é‚®ä»¶è‡ªåŠ¨è°ƒç”¨ç¿»è¯‘ API
3. **æ™ºèƒ½ç¿»è¯‘**ï¼šæ£€æµ‹é‚®ä»¶ä¸­çš„å¼•ç”¨å†…å®¹ï¼Œåªç¿»è¯‘æ–°å¢éƒ¨åˆ†
4. ç¿»è¯‘ç»“æœå­˜å…¥ `shared_email_translations` è¡¨
5. åç»­å…¶ä»–ç”¨æˆ·æ‹‰å–åŒä¸€å°é‚®ä»¶æ—¶ç›´æ¥å¤ç”¨ç¿»è¯‘

**æ™ºèƒ½ç¿»è¯‘ï¼ˆå›å¤é‚®ä»¶ä¼˜åŒ–ï¼‰**ï¼š
- è‡ªåŠ¨æ£€æµ‹å¼•ç”¨æ ‡è®°ï¼ˆ`On ... wrote:`, `From:`, `>` ç­‰ï¼‰
- åªç¿»è¯‘æ–°å¢å†…å®¹ï¼Œè·³è¿‡å¼•ç”¨éƒ¨åˆ†
- å°è¯•å¤ç”¨å¼•ç”¨é‚®ä»¶çš„å·²æœ‰ç¿»è¯‘ï¼ˆé€šè¿‡ `in_reply_to` æŸ¥æ‰¾ï¼‰
- æ˜¾è‘—å‡å°‘ API è°ƒç”¨æ¬¡æ•°ï¼Œé™ä½ç¿»è¯‘æˆæœ¬

**è§¦å‘æ—¶æœº**ï¼š
- ç”¨æˆ·ç‚¹å‡»"æ‹‰å–é‚®ä»¶"æŒ‰é’®
- å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ‹‰å–ï¼ˆè§ä¸‹æ–¹æ‰¹é‡ç¿»è¯‘ç­–ç•¥ï¼‰

### 4. æ‰¹é‡ç¿»è¯‘ç­–ç•¥ï¼ˆè®¡åˆ’ä¸­ï¼‰

ä¸ºè¿›ä¸€æ­¥ä¼˜åŒ– API æˆæœ¬ï¼Œè®¡åˆ’ä½¿ç”¨ Claude API Batch è¿›è¡Œæ‰¹é‡ç¿»è¯‘ï¼š

```
å®šæ—¶ä»»åŠ¡ï¼ˆæ¯åˆ†é’Ÿï¼‰
       â†“
æ”¶é›†æ‰€æœ‰æœªç¿»è¯‘é‚®ä»¶
       â†“
ç«‹å³æäº¤ Batch APIï¼ˆæäº¤è¦åŠæ—¶ï¼‰
       â†“
åå°è½®è¯¢æ£€æŸ¥ç»“æœï¼ˆè¿”å›éšæ„ï¼Œå‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶ï¼‰
       â†“
ç»“æœå†™å…¥ shared_email_translations
       â†“
ç”¨æˆ·åˆ·æ–°æ—¶çœ‹åˆ°ç¿»è¯‘ç»“æœ
```

**Batch API ä¼˜åŠ¿**ï¼š
| ç‰¹æ€§ | æ™®é€š API | Batch API |
|------|----------|-----------|
| ä»·æ ¼ | 100% | 50%ï¼ˆåŠä»·ï¼‰ |
| å“åº” | å®æ—¶ | å¼‚æ­¥ |
| é€‚ç”¨ | ç”¨æˆ·äº¤äº’ | åå°æ‰¹é‡ |

**æ•°æ®æ¨¡å‹**ï¼š

```
translation_batches è¡¨ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ id                # ä¸»é”®
â”œâ”€â”€ batch_id          # Claude è¿”å›çš„ Batch ID
â”œâ”€â”€ status            # pending / submitted / completed / failed
â”œâ”€â”€ email_count       # åŒ…å«é‚®ä»¶æ•°é‡
â”œâ”€â”€ submitted_at      # æäº¤æ—¶é—´
â””â”€â”€ completed_at      # å®Œæˆæ—¶é—´

emails è¡¨ï¼ˆæ–°å¢å­—æ®µï¼‰
â”œâ”€â”€ translation_status  # pending / submitted / completed
â””â”€â”€ batch_id           # å…³è”çš„ Batch ID
```

**æ··åˆç­–ç•¥**ï¼š
- ç”¨æˆ·ä¸»åŠ¨æŸ¥çœ‹é‚®ä»¶è¯¦æƒ… â†’ å®æ—¶ç¿»è¯‘ï¼ˆç«‹å³æ˜¾ç¤ºï¼‰
- åå°æœªè¯»é‚®ä»¶ â†’ åŠ å…¥æ‰¹é‡é˜Ÿåˆ— â†’ Batch API å¤„ç†

**å®ç°æ­¥éª¤**ï¼š
1. æ·»åŠ  `translation_batches` è¡¨
2. æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆAPSchedulerï¼Œæ¯åˆ†é’Ÿæäº¤ï¼‰
3. æ·»åŠ è½®è¯¢ä»»åŠ¡ï¼ˆæ¯ 5 åˆ†é’Ÿæ£€æŸ¥ Batch çŠ¶æ€ï¼‰
4. é›†æˆ Claude Batch API

**å½“å‰æµ‹è¯•**ï¼šå…ˆç”¨æœ¬åœ° Ollama æ¨¡å‹æµ‹è¯•å®šæ—¶ä»»åŠ¡æµç¨‹ï¼Œç¡®è®¤æ— è¯¯åå†åˆ‡æ¢åˆ° Claude Batch API

## Celery å¼‚æ­¥ä»»åŠ¡ç³»ç»Ÿ

ä½¿ç”¨ Celery + Redis å®ç°åå°å¼‚æ­¥ä»»åŠ¡ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

### æ¶æ„

```
ç”¨æˆ·æ“ä½œ â†’ FastAPIï¼ˆç«‹å³è¿”å›ä»»åŠ¡IDï¼‰â†’ å‰ç«¯æ˜¾ç¤º"å¤„ç†ä¸­"
                    â†“
            Redisï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰
                    â†“
            Celery Workerï¼ˆåå°æ‰§è¡Œï¼‰
                    â†“
            å®Œæˆ â†’ æ›´æ–°æ•°æ®åº“ â†’ WebSocket æ¨é€å‰ç«¯åˆ·æ–°
```

### æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `backend/celery_app.py` | Celery é…ç½®å’Œå®ä¾‹ |
| `backend/tasks/translate_tasks.py` | ç¿»è¯‘ä»»åŠ¡ï¼ˆå•ä¸ªã€æ‰¹é‡ã€Batchè½®è¯¢ï¼‰ |
| `backend/tasks/email_tasks.py` | é‚®ä»¶ä»»åŠ¡ï¼ˆæ‹‰å–ã€å‘é€ã€å¯¼å‡ºï¼‰ |
| `backend/tasks/ai_tasks.py` | AI æå–ä»»åŠ¡ |
| `backend/tasks/maintenance_tasks.py` | å®šæ—¶ç»´æŠ¤ä»»åŠ¡ |
| `backend/websocket.py` | WebSocket è¿æ¥ç®¡ç† |
| `backend/services/notification_service.py` | æ¨é€é€šçŸ¥æœåŠ¡ |
| `frontend/src/utils/websocket.js` | WebSocket å®¢æˆ·ç«¯ |

### ä»»åŠ¡åˆ—è¡¨

| ä»»åŠ¡ | è¯´æ˜ | åŸè€—æ—¶ | ä¼˜åŒ–å |
|------|------|--------|--------|
| `translate_email_task` | ç¿»è¯‘å•å°é‚®ä»¶ | 3-10s | 100mså“åº” |
| `batch_translate_task` | æ‰¹é‡ç¿»è¯‘ | 400-500s | 30så“åº” |
| `fetch_emails_task` | æ‹‰å–é‚®ä»¶ | 50-100s | 15så“åº” |
| `send_email_task` | å‘é€é‚®ä»¶ | 2-7s | 100mså“åº” |
| `export_emails_task` | å¯¼å‡ºé‚®ä»¶ | 5-15s | 100mså“åº” |
| `extract_email_info_task` | AI æå– | 5-20s | 100mså“åº” |

### å®šæ—¶ä»»åŠ¡

| ä»»åŠ¡ | å‘¨æœŸ | è¯´æ˜ |
|------|------|------|
| `warm_translation_cache` | æ¯å°æ—¶ | é¢„çƒ­é«˜é¢‘ç¿»è¯‘åˆ° Redis |
| `cleanup_old_translations` | æ¯å¤©2ç‚¹ | æ¸…ç†30å¤©æœªç”¨ç¼“å­˜ |
| `cleanup_temp_files` | æ¯å¤©3ç‚¹ | æ¸…ç†ä¸´æ—¶å¯¼å‡ºæ–‡ä»¶ |
| `rebuild_contacts_index` | æ¯å¤©4ç‚¹ | é‡å»ºè”ç³»äººç¼“å­˜ |
| `poll_batch_status` | æ¯30ç§’ | è½®è¯¢ Batch API çŠ¶æ€ |

### WebSocket äº‹ä»¶

| äº‹ä»¶ | è¯´æ˜ |
|------|------|
| `translation_complete` | ç¿»è¯‘å®Œæˆ |
| `translation_failed` | ç¿»è¯‘å¤±è´¥ |
| `email_sent` | é‚®ä»¶å‘é€æˆåŠŸ |
| `fetch_progress` | æ‹‰å–è¿›åº¦æ›´æ–° |
| `fetch_complete` | æ‹‰å–å®Œæˆ |
| `extraction_complete` | AI æå–å®Œæˆ |
| `export_ready` | å¯¼å‡ºå®Œæˆï¼Œå¯ä¸‹è½½ |
| `batch_translation_complete` | æ‰¹é‡ç¿»è¯‘å®Œæˆ |

### éƒ¨ç½²å‘½ä»¤

```bash
# 1. å®‰è£…ä¾èµ–
pip install celery[redis] redis flower pymysql

# 2. å¯åŠ¨ Celery Worker
celery -A celery_app worker -l info

# 3. å¯åŠ¨ Celery Beatï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
celery -A celery_app beat -l info

# 4. å¯åŠ¨ Flower ç›‘æ§ï¼ˆå¯é€‰ï¼‰
celery -A celery_app flower --port=5555

# PM2 é…ç½®
pm2 start "celery -A celery_app worker -l info" --name celery-worker
pm2 start "celery -A celery_app beat -l info" --name celery-beat
```

### ç¯å¢ƒå˜é‡

```bash
# .env æ·»åŠ 
CELERY_BROKER_URL=redis://localhost:6379/1
CELERY_RESULT_BACKEND=redis://localhost:6379/2
```

### ä»»åŠ¡çŠ¶æ€ API

| ç«¯ç‚¹ | è¯´æ˜ |
|------|------|
| `GET /api/tasks/{task_id}` | æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ |
| `DELETE /api/tasks/{task_id}` | å–æ¶ˆä»»åŠ¡ |
| `POST /api/tasks/translate/email/{id}` | æäº¤ç¿»è¯‘ä»»åŠ¡ |
| `POST /api/tasks/translate/batch` | æäº¤æ‰¹é‡ç¿»è¯‘ |
| `POST /api/tasks/fetch` | æäº¤æ‹‰å–ä»»åŠ¡ |
| `POST /api/tasks/send/{draft_id}` | æäº¤å‘é€ä»»åŠ¡ |
| `POST /api/tasks/extract/{email_id}` | æäº¤æå–ä»»åŠ¡ |
| `POST /api/tasks/export` | æäº¤å¯¼å‡ºä»»åŠ¡ |

## åŠŸèƒ½å®ç°çŠ¶æ€

å¯¹æ¯”æ ‡å‡†é‚®ä»¶å®¢æˆ·ç«¯ï¼ˆOutlookã€Gmailï¼‰ï¼Œä»¥ä¸‹æ˜¯å„åŠŸèƒ½çš„å®ç°çŠ¶æ€ï¼š

### å·²å®ŒæˆåŠŸèƒ½ âœ“

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| é‚®ç®±ç™»å½•è®¤è¯ | IMAP éªŒè¯ + JWT token |
| è®°ä½ç™»å½•çŠ¶æ€ | localStorage æŒä¹…åŒ–ï¼Œ7å¤©æœ‰æ•ˆ |
| é‚®ä»¶åˆ—è¡¨æ˜¾ç¤º | åŒè¯­å¯¹æ¯”è§†å›¾ï¼ˆåŸæ–‡/è¯‘æ–‡ï¼‰ |
| é‚®ä»¶è¯¦æƒ…æŸ¥çœ‹ | åˆ†æ æ˜¾ç¤ºåŸæ–‡å’Œç¿»è¯‘ |
| æ‰‹åŠ¨æ‹‰å–é‚®ä»¶ | ç‚¹å‡»"åŒæ­¥"æŒ‰é’® |
| è‡ªåŠ¨å®šæ—¶æ‹‰å– | æ¯5åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥æ–°é‚®ä»¶ï¼ˆå‰ç«¯å®šæ—¶å™¨å®ç°ï¼‰ |
| æ–°é‚®ä»¶æ¡Œé¢é€šçŸ¥ | Electron Notification API |
| æ™ºèƒ½ç¿»è¯‘ | æ”¯æŒ Ollama/Claude |
| ç¿»è¯‘ç¼“å­˜ | ç›¸åŒæ–‡æœ¬åªç¿»è¯‘ä¸€æ¬¡ |
| é‚®ä»¶ç¿»è¯‘å…±äº« | åŒä¸€å°é‚®ä»¶è·¨ç”¨æˆ·åªç¿»è¯‘ä¸€æ¬¡ |
| é‚®ä»¶æ ‡è®° | æ˜Ÿæ ‡ã€å·²è¯»/æœªè¯» |
| é‚®ä»¶åˆ é™¤ | å•ä¸ªåˆ é™¤ |
| æ‰¹é‡æ ‡è®°å·²è¯» | POST /api/emails/batch/read |
| æ‰¹é‡æ ‡è®°æœªè¯» | POST /api/emails/batch/unread |
| æ‰¹é‡åˆ é™¤ | POST /api/emails/batch/delete |
| å›å¤é‚®ä»¶ | ä¸­æ–‡æ’°å†™ â†’ ç¿»è¯‘ â†’ å‘é€ |
| è‰ç¨¿ä¿å­˜ | ä¿å­˜å›å¤è‰ç¨¿ |
| ä¾›åº”å•†ç®¡ç† | æŒ‰åŸŸååˆ†ç±»ä¾›åº”å•† |
| é‚®ä»¶æœç´¢ | æŒ‰ä¸»é¢˜ã€å‘ä»¶äººæœç´¢ |
| é‚®ä»¶æ’åº | æŒ‰æ—¶é—´ã€å‘ä»¶äººæ’åº |
| è¯­è¨€æ£€æµ‹ | è‡ªåŠ¨è¯†åˆ«é‚®ä»¶è¯­è¨€ |
| é™„ä»¶å­˜å‚¨ | ä¿å­˜åˆ°æœåŠ¡å™¨ |
| é™„ä»¶ä¸‹è½½ | å•ä¸ªä¸‹è½½ã€æ‰¹é‡ä¸‹è½½ |
| ç™»å½•åè‡ªåŠ¨æ‹‰å– | é¦–æ¬¡ç™»å½•è‡ªåŠ¨åŒæ­¥é‚®ä»¶ |
| é‚®ä»¶çº¿ç¨‹æ˜¾ç¤º | å¯¹è¯åˆ†ç»„å±•ç¤º |
| æœªè¯»è®¡æ•° | æ˜¾ç¤ºçœŸæ­£çš„æœªè¯»é‚®ä»¶æ•° |
| å¢é‡æ‹‰å– | åªæ‹‰å–æœ€æ–°é‚®ä»¶ï¼Œå‡å°‘æœåŠ¡å™¨è´Ÿè½½ |
| å•å®ä¾‹é”å®š | é˜²æ­¢å¤šä¸ªå®ä¾‹åŒæ—¶è¿è¡Œ |
| å¯åŠ¨ç”»é¢ | Electron å¯åŠ¨æ—¶æ˜¾ç¤ºåŠ è½½ç”»é¢ |
| åº”ç”¨è‡ªåŠ¨æ›´æ–° | electron-updater å®ç° |
| é‚®ä»¶å¯¼å‡º | å¯¼å‡ºä¸º EML æ ¼å¼ |
| é‚®ä»¶ç­¾å | è‡ªå®šä¹‰ç­¾åæ¨¡æ¿ï¼Œæ”¯æŒå¤šè¯­è¨€ç¿»è¯‘ |
| æ”¶ä»¶äººè‡ªåŠ¨è¡¥å…¨ | æ ‡ç­¾å¼è¾“å…¥ï¼Œæ”¯æŒå†å²è”ç³»äººæœç´¢ |
| é‚®ä»¶å›å¤å¢å¼º | å…¨éƒ¨å›å¤ã€æ”¶ä»¶äºº/æŠ„é€å»é‡ã€é‚®ç®±éªŒè¯ |

### å¾…å®ç°åŠŸèƒ½

#### ä½ä¼˜å…ˆçº§ ğŸŸ¢

| åŠŸèƒ½ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| å¿«æ·é”®ç³»ç»Ÿ | åˆ é™¤(D)ã€å›å¤(R)ã€æ ‡è®°(S) | ä»…Enteré”® |
| æ–°é‚®ä»¶å£°éŸ³æç¤º | æ’­æ”¾æç¤ºéŸ³ | æœªå®ç° |

### é…ç½®å‚æ•°

```python
# backend/config.py
email_poll_interval: int = 300  # è‡ªåŠ¨æ‹‰å–é—´éš”ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤5åˆ†é’Ÿ
```

### ç­¾åç›¸å…³ API ç«¯ç‚¹

```
GET  /api/signatures            # è·å–ç”¨æˆ·ç­¾ååˆ—è¡¨
GET  /api/signatures/default    # è·å–é»˜è®¤ç­¾å
GET  /api/signatures/{id}       # è·å–å•ä¸ªç­¾å
POST /api/signatures            # åˆ›å»ºç­¾å
PUT  /api/signatures/{id}       # æ›´æ–°ç­¾å
DELETE /api/signatures/{id}     # åˆ é™¤ç­¾å
POST /api/signatures/{id}/set-default  # è®¾ä¸ºé»˜è®¤ç­¾å
```

## CI/CD è‡ªåŠ¨åŒ–éƒ¨ç½²

é¡¹ç›®ä½¿ç”¨ GitHub Actions å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼ŒåŒ…æ‹¬åç«¯éƒ¨ç½²å’Œæ¡Œé¢ç«¯å‘å¸ƒã€‚

### åç«¯è‡ªåŠ¨éƒ¨ç½²

æ¨é€åˆ° `main` åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘ï¼š

```
git push origin main
    â†“
GitHub Actions (.github/workflows/deploy.yml)
    â†“
SSH è¿æ¥æœåŠ¡å™¨ â†’ æ‹‰å–ä»£ç  â†’ å®‰è£…ä¾èµ– â†’ é‡å¯ PM2
```

### æ¡Œé¢ç«¯å‘å¸ƒæµç¨‹

ä¸¤ç§æ–¹å¼è§¦å‘å‘å¸ƒï¼š

#### æ–¹å¼ä¸€ï¼šæ‰“ Tag å‘å¸ƒï¼ˆæ¨èï¼‰

```bash
# 1. ä¿®æ”¹ç‰ˆæœ¬å·
cd frontend
npm version 1.0.1  # è‡ªåŠ¨æ›´æ–° package.json å¹¶åˆ›å»º git tag

# 2. æ¨é€ä»£ç å’Œ tag
git push origin main --tags
```

#### æ–¹å¼äºŒï¼šæ‰‹åŠ¨è§¦å‘

1. æ‰“å¼€ GitHub ä»“åº“ â†’ Actions â†’ "Build and Release Desktop App"
2. ç‚¹å‡» "Run workflow"
3. è¾“å…¥ç‰ˆæœ¬å·ï¼ˆå¦‚ 1.0.1ï¼‰
4. ç‚¹å‡»è¿è¡Œ

### å‘å¸ƒæµç¨‹è¯¦æƒ…

```
è§¦å‘å‘å¸ƒï¼ˆæ¨é€ v* æ ‡ç­¾ï¼‰
    â†“
GitHub Actions (Windows Runner)
    â†“
â”œâ”€â”€ æ‰“åŒ…åç«¯ (PyInstaller)
â”œâ”€â”€ æ„å»ºå‰ç«¯ (Vite)
â”œâ”€â”€ æ‰“åŒ… Electron (electron-builder)
    â†“
ä¸Šä¼ åˆ° GitHub Releases
â”œâ”€â”€ ä¾›åº”å•†é‚®ä»¶ç¿»è¯‘ç³»ç»Ÿ Setup x.x.x.exe
â””â”€â”€ latest.yml
    â†“
ç”¨æˆ·ç«¯è‡ªåŠ¨æ£€æµ‹æ›´æ–° â†’ ä» GitHub ä¸‹è½½å®‰è£…
```

### æ›´æ–°æ‰˜ç®¡é…ç½®

| é…ç½®é¡¹ | å€¼ |
|--------|-----|
| æ‰˜ç®¡æ–¹å¼ | GitHub Releases |
| ä»“åº“ | `zp184764679/email-translate` |
| electron-updater provider | `github` |

**ä¸ºä»€ä¹ˆä½¿ç”¨ GitHub Releases è€Œä¸æ˜¯è‡ªå»ºæœåŠ¡å™¨ï¼š**
- GitHub Actions åœ¨ç¾å›½ï¼Œä¸Šä¼ åˆ°ä¸­å›½æœåŠ¡å™¨è·¨å›½ä¼ è¾“å¾ˆæ…¢ï¼ˆ100MB+ æ–‡ä»¶éœ€è¦ 20+ åˆ†é’Ÿï¼‰
- GitHub CDN å…¨çƒåˆ†å¸ƒï¼Œç”¨æˆ·ä¸‹è½½æ›´å¿«
- æ— éœ€ç»´æŠ¤æ–‡ä»¶æœåŠ¡å™¨
- å‘å¸ƒè®°å½•è‡ªåŠ¨ä¿å­˜ï¼Œä¾¿äºç‰ˆæœ¬ç®¡ç†

### GitHub Secrets é…ç½®

| Secret åç§° | è¯´æ˜ | ç”¨é€” |
|-------------|------|------|
| `SERVER_HOST` | æœåŠ¡å™¨ IP (61.145.212.28) | åç«¯éƒ¨ç½² |
| `SERVER_USER` | SSH ç”¨æˆ·å (root) | åç«¯éƒ¨ç½² |
| `SSH_PRIVATE_KEY` | SSH ç§é’¥ (email_deploy) | åç«¯éƒ¨ç½² |
| `GITHUB_TOKEN` | è‡ªåŠ¨æä¾› | å‘å¸ƒåˆ° GitHub Releases |

### å¿«é€Ÿå‘å¸ƒå‘½ä»¤

```bash
# å‘å¸ƒæ–°ç‰ˆæœ¬ï¼ˆä¸€è¡Œå‘½ä»¤ï¼‰
git tag -a v1.0.5 -m "release: æ–°åŠŸèƒ½æè¿°" && git push origin v1.0.5

# æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬
git tag -l

# åˆ é™¤é”™è¯¯çš„æ ‡ç­¾ï¼ˆæœ¬åœ°+è¿œç¨‹ï¼‰
git tag -d v1.0.5 && git push origin :refs/tags/v1.0.5
```

### ç‰ˆæœ¬å·è§„èŒƒ

éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼š`ä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢å·`

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| ä¸»ç‰ˆæœ¬ | ä¸å…¼å®¹çš„å¤§æ”¹åŠ¨ | 1.0.0 â†’ 2.0.0 |
| æ¬¡ç‰ˆæœ¬ | æ–°å¢åŠŸèƒ½ï¼ˆå‘åå…¼å®¹ï¼‰ | 1.0.0 â†’ 1.1.0 |
| ä¿®è®¢å· | Bug ä¿®å¤ | 1.0.0 â†’ 1.0.1 |
