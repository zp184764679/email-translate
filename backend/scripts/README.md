# 维护脚本

## 附件重新扫描脚本

**文件**: `refresh_attachments.py`

**用途**: 重新从 IMAP 服务器拉取邮件并更新附件信息

### 使用场景

1. 附件检测逻辑优化后，需要更新历史邮件
2. 修复附件丢失或显示不正确的问题

### 运行方式

#### 1. 更新所有邮件的附件

```bash
cd backend
python -m scripts.refresh_attachments
```

这会：
- 连接所有活跃账户的 IMAP 服务器
- 重新拉取每封邮件的附件信息
- 更新数据库中的附件记录

#### 2. 更新单个邮件的附件

```bash
cd backend
python -m scripts.refresh_attachments --email-id 123
```

将 `123` 替换为具体的邮件 ID。

### 注意事项

1. **需要网络连接** - 脚本会连接 IMAP 服务器重新拉取邮件
2. **执行时间** - 邮件量大时可能需要较长时间
3. **数据库备份** - 建议执行前备份数据库
4. **IMAP 限制** - 频繁操作可能触发服务器限制

### 输出示例

```
🔄 开始重新扫描附件...
============================================================

📧 处理账户: user@jingzhicheng.com.cn
   📊 找到 156 封邮件
   🔌 连接 IMAP 服务器...
   ✅ Re: Shenzhen RTV Michelle Profeta: 11 个附件
   ✅ 采购订单确认: 3 个附件
   📈 更新了 24 封邮件，新增 45 个附件

============================================================
✨ 完成！共更新 24 封邮件，45 个附件
```

### 故障排查

**问题**: `❌ 在 IMAP 服务器上未找到该邮件`

**原因**: 邮件可能已从服务器删除

**解决**: 跳过该邮件，无需处理

---

**问题**: `❌ 连接 IMAP 服务器失败`

**原因**: 网络问题或服务器限制

**解决**: 检查网络连接，稍后重试
