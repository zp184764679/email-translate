name: Build and Release Desktop App

on:
  push:
    tags:
      - 'v*'  # 推送 v1.0.0 这样的 tag 时触发
  workflow_dispatch:  # 支持手动触发
    inputs:
      version:
        description: '版本号 (如 1.0.1)'
        required: true
        default: '1.0.0'

permissions:
  contents: write

jobs:
  # ==================== 并行构建：后端 ====================
  build-backend:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      # 缓存 PyInstaller 工作目录
      - name: Cache PyInstaller
        uses: actions/cache@v4
        with:
          path: |
            backend/build
            ~/.cache/pip
          key: pyinstaller-${{ runner.os }}-py312-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            pyinstaller-${{ runner.os }}-py312-

      # 安装 UPX 压缩工具（减小 exe 体积）
      - name: Install UPX
        run: |
          choco install upx -y
        shell: powershell

      # 打包后端（使用多线程）
      - name: Build Backend
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pyinstaller
          # 使用 --jobs 参数启用多核编译
          pyinstaller backend.spec --noconfirm
        shell: bash

      # 上传后端产物
      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-exe
          path: backend/dist/backend.exe
          retention-days: 1

  # ==================== 并行构建：前端 ====================
  build-frontend:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 更新版本号（手动触发时）
      - name: Update version
        if: github.event_name == 'workflow_dispatch'
        run: |
          cd frontend
          npm version ${{ github.event.inputs.version }} --no-git-tag-version
        shell: bash

      # 安装依赖并构建前端
      - name: Build Frontend
        run: |
          cd frontend
          npm ci
          npm run build
        shell: bash

      # 上传前端产物
      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

  # ==================== 合并打包 Electron ====================
  package-electron:
    runs-on: windows-latest
    needs: [build-backend, build-frontend]  # 等待并行构建完成
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 缓存 Electron 和 electron-builder
      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            ~/AppData/Local/electron/Cache
            ~/AppData/Local/electron-builder/Cache
          key: electron-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            electron-${{ runner.os }}-

      # 下载后端产物
      - name: Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-exe
          path: backend/dist

      # 下载前端产物
      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      # 更新版本号（手动触发时）
      - name: Update version
        if: github.event_name == 'workflow_dispatch'
        run: |
          cd frontend
          npm version ${{ github.event.inputs.version }} --no-git-tag-version
        shell: bash

      # 安装前端依赖（仅用于 electron-builder）
      - name: Install Dependencies
        run: |
          cd frontend
          npm ci
        shell: bash

      # 打包 Electron（带重试机制）
      - name: Build Electron
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 30
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            cd frontend
            npx electron-builder --win --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 先上传到 GitHub Releases
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            frontend/dist_electron/*.exe
            frontend/dist_electron/latest.yml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 然后让服务器从 GitHub 下载（服务器下载比 scp 上传更快）
      - name: Setup SSH Key
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Trigger Server Download
        shell: bash
        run: |
          SERVER="${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
          SSH_OPTS="-i ~/.ssh/deploy_key -o StrictHostKeyChecking=no"
          VERSION="${GITHUB_REF_NAME}"

          echo "=== 让服务器从 GitHub 下载更新文件（使用代理）==="
          ssh $SSH_OPTS $SERVER "
            cd /www/email-translate/updates || mkdir -p /www/email-translate/updates && cd /www/email-translate/updates

            # 代理配置
            PROXY='http://127.0.0.1:10900'

            echo '下载 latest.yml...'
            curl -x \$PROXY -sL -o latest.yml 'https://github.com/zp184764679/email-translate/releases/download/${VERSION}/latest.yml'

            echo '获取 exe 文件名...'
            # 从 latest.yml 获取期望的文件名（中文名）
            EXPECTED_NAME=\$(grep -oP '(?<=url: ).*\.exe' latest.yml | head -1)
            echo \"期望的文件名: \$EXPECTED_NAME\"

            # 从 GitHub API 获取实际上传的 exe 文件名
            ACTUAL_NAME=\$(curl -x \$PROXY -sL 'https://api.github.com/repos/zp184764679/email-translate/releases/latest' | grep -oP '\"name\": \"[^\"]*\.exe\"' | head -1 | sed 's/\"name\": \"\(.*\)\"/\1/')
            echo \"GitHub上的实际文件名: \$ACTUAL_NAME\"

            if [ -n \"\$ACTUAL_NAME\" ]; then
              echo '下载 exe 文件（使用代理）...'
              curl -x \$PROXY -L -o \"\$EXPECTED_NAME\" \"https://github.com/zp184764679/email-translate/releases/download/${VERSION}/\$ACTUAL_NAME\"
              echo \"已下载并保存为: \$EXPECTED_NAME\"
            fi

            chmod 644 /www/email-translate/updates/*
            ls -la /www/email-translate/updates/
            echo '更新文件下载完成！'
          "
