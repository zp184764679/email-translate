name: Build and Release Desktop App

on:
  push:
    tags:
      - 'v*'  # 推送 v1.0.0 这样的 tag 时触发
  workflow_dispatch:  # 支持手动触发
    inputs:
      version:
        description: '版本号 (如 1.0.1)'
        required: true
        default: '1.0.0'

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      # 缓存 Electron 和 electron-builder
      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            ~/AppData/Local/electron/Cache
            ~/AppData/Local/electron-builder/Cache
          key: electron-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            electron-${{ runner.os }}-

      # 更新版本号（手动触发时）
      - name: Update version
        if: github.event_name == 'workflow_dispatch'
        run: |
          cd frontend
          npm version ${{ github.event.inputs.version }} --no-git-tag-version
        shell: bash

      # 打包后端
      - name: Build Backend
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pyinstaller
          pyinstaller backend.spec --noconfirm
        shell: bash

      # 构建前端
      - name: Build Frontend
        run: |
          cd frontend
          npm ci
          npm run build
        shell: bash

      # 打包 Electron（带重试机制）
      - name: Build Electron
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 30
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            cd frontend
            npx electron-builder --win --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 上传更新文件到服务器（使用 PowerShell + SCP）
      - name: Deploy to Update Server
        shell: pwsh
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # 保存 SSH 密钥
          $keyPath = "$env:TEMP\deploy_key"
          $env:SSH_KEY | Out-File -FilePath $keyPath -Encoding ASCII -NoNewline

          # 修复权限（Windows 上需要）
          icacls $keyPath /inheritance:r /grant:r "${env:USERNAME}:(R)"

          # 创建远程目录
          ssh -i $keyPath -o StrictHostKeyChecking=no "$env:SERVER_USER@$env:SERVER_HOST" "mkdir -p /var/www/html/email-updates"

          # 上传文件
          $files = Get-ChildItem -Path "frontend/dist_electron" -Include "*.exe","*.blockmap","latest.yml" -File
          foreach ($file in $files) {
            Write-Host "Uploading $($file.Name)..."
            scp -i $keyPath -o StrictHostKeyChecking=no $file.FullName "$env:SERVER_USER@$env:SERVER_HOST:/var/www/html/email-updates/"
          }

          # 设置权限
          ssh -i $keyPath -o StrictHostKeyChecking=no "$env:SERVER_USER@$env:SERVER_HOST" "chmod 644 /var/www/html/email-updates/* && ls -la /var/www/html/email-updates/"

          # 清理密钥
          Remove-Item $keyPath -Force

      # 上传到 GitHub Releases（可选）
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            frontend/dist_electron/*.exe
            frontend/dist_electron/latest.yml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
